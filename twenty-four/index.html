<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>24 Game — Four Numbers to 24</title>
    <meta name="description" content="24 Game: Use four numbers and + - × ÷ to make 24." />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/src/index.css" />
    <script>
      (function(){
         var isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1'
         if (isLocal) return
         var ad = document.createElement('script')
         ad.async = true
         ad.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5101109858499684"
         ad.crossOrigin = "anonymous"
         document.head.appendChild(ad)
      })()
    </script>
    <style>
      .game-grid {
        display: grid;
        grid-template-columns: repeat(2, 120px);
        grid-template-rows: repeat(2, 100px);
        gap: 16px;
      }
      .game-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: 700;
        border-radius: 20px;
        cursor: pointer;
        transition: transform 0.1s, background-color 0.2s;
        user-select: none;
      }
      .game-btn:active {
        transform: scale(0.96);
      }
      .op-btn {
        background-color: #f0f0f0;
      }
      .op-btn:hover {
        background-color: #e0e0e0;
      }
      .number-btn {
        background-color: #fff;
        border: 2px solid var(--color-border);
      }
      .number-btn:hover {
        border-color: #999;
      }
      .game-btn.selected {
        background-color: #007aff;
        color: white;
        border-color: #007aff;
      }
      .display-screen {
        width: 100%;
        max-width: 760px;
        background: #f8f9fa;
        border: 2px solid var(--color-border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: center;
        min-height: 100px;
      }
      .display-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
        align-self: flex-start;
      }
      .display-input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 32px;
        font-weight: 600;
        text-align: right;
        font-family: monospace;
        outline: none;
        color: #333;
      }
      .display-input::placeholder {
        color: #ccc;
      }
    </style>
  </head>
  <body>
    <header>
      <div id="site-header"></div>
    </header>
    <main class="main-wrap">
      <div class="container page-fit">
        <div class="breadcrumb">
          <a href="/index.html">Home</a>
          <span>›</span>
          <span class="crumb-middle">24 Game</span>
        </div>
        <!-- Hero section removed -->
        <section class="grid-section" style="padding-top:20px">
          <div class="grid-bg">
            <div style="display:flex;flex-direction:column;align-items:center;gap:24px">
              
              <div class="display-screen" style="border:none;background:transparent;padding:0;min-height:auto;margin-bottom:10px">
                <!-- <span class="display-label">OPERATION RECORD</span> -->
                <input id="exprInput" class="display-input" type="text" placeholder="" readonly style="text-align:center;font-size:40px;height:auto" />
              </div>

              <div style="display:flex;gap:24px;align-items:flex-start;justify-content:center;flex-wrap:wrap">
                <div id="numbersGrid" class="game-grid"></div>
                <div id="operatorsGrid" class="game-grid">
                  <div class="btn op-btn game-btn">+</div>
                  <div class="btn op-btn game-btn">-</div>
                  <div class="btn op-btn game-btn">×</div>
                  <div class="btn op-btn game-btn">÷</div>
                </div>
              </div>

              <div style="width:100%;max-width:540px;display:flex;gap:12px;margin-top:20px">
                <button id="undoBtn" class="btn" style="flex:1;font-size:18px;height:56px">Undo</button>
                <button id="showAnswerBtn" class="btn" style="flex:1;font-size:18px;height:56px;background-color:#6c757d;color:white;border-color:#6c757d">Show Answer</button>
                <button id="replayBtn" class="btn" style="flex:1;height:56px;font-size:18px">Replay</button>
              </div>
              
              <div id="resultRow" class="secondary" style="font-size:24px;font-weight:700;min-height:36px;margin-top:12px;text-align:center;width:100%;color:#333"></div>

              <div id="actionsRow" style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:12px;width:100%;max-width:540px">
                <button id="newSetBtn" class="btn btn-primary" style="width:100%;height:56px;font-size:18px;background-color:#007aff;border-color:#007aff;color:white">New Puzzle</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <div id="site-footer"></div>
    <script>
      (function(){
        Promise.all([
          fetch('/partials/header.html').then(r=>r.text()),
          fetch('/partials/footer.html').then(r=>r.text())
        ]).then(([h,f])=>{
          var sh = document.getElementById('site-header'); if (sh) sh.innerHTML = h
          var sf = document.getElementById('site-footer'); if (sf) sf.innerHTML = f
        })
      })()
    </script>
    <script>
      (function(){
        const qs = s => document.querySelector(s)
        const qsa = s => Array.from(document.querySelectorAll(s))
        const EPS = 1e-6
        let nums = []
        let lastNums = [] // Store initial numbers for reset/solver
        let history = [] // Array of {nums: [], lastOp: string}
        let selectedIdx = null
        let selectedOp = null
        
        // ... (canMake24 and genSolvable remain same)
        function randInt(n){ return Math.floor(Math.random()*n) }
        function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

        function canMake24(arr) {
          function dfs(list) {
            if (list.length === 1) return Math.abs(list[0] - 24) < EPS
            for (let i = 0; i < list.length; i++) {
              for (let j = 0; j < list.length; j++) {
                if (i === j) continue
                const a = list[i], b = list[j]
                const next = []
                for (let k = 0; k < list.length; k++) if (k !== i && k !== j) next.push(list[k])
                const ops = [
                  a + b,
                  a - b,
                  b - a,
                  a * b,
                ]
                if (Math.abs(b) > EPS) ops.push(a / b)
                if (Math.abs(a) > EPS) ops.push(b / a)
                for (const v of ops) {
                  next.push(v)
                  if (dfs(next)) return true
                  next.pop()
                }
              }
            }
            return false
          }
          return dfs(arr.map(Number))
        }

        function genSolvable() {
          for (let tries = 0; tries < 200; tries++) {
            const a = randInt(9)+1, b = randInt(9)+1, c = randInt(9)+1, d = randInt(9)+1
            const arr = [a,b,c,d]
            if (canMake24(arr)) return arr
          }
          return [6,6,4,2]
        }

        function renderNumbers() {
          const grid = qs('#numbersGrid')
          grid.innerHTML = ''
          nums.forEach((n, idx) => {
            const tag = document.createElement('div')
            tag.textContent = Number.isInteger(n) ? n : parseFloat(n.toFixed(2))
            tag.className = 'btn number-btn game-btn'
            if (selectedIdx === idx) tag.classList.add('selected')
            tag.addEventListener('click', () => handleNumberClick(idx))
            grid.appendChild(tag)
          })

          // Render Operators Selection State
          qsa('.op-btn').forEach(btn => {
            btn.classList.remove('selected')
            if (selectedOp === btn.textContent) btn.classList.add('selected')
          })
        }

        function handleNumberClick(idx) {
          qs('#resultRow').textContent = ''
          
          if (selectedIdx === null) {
            // Step 1: Select first number
            selectedIdx = idx
            renderNumbers()
            return
          }

          if (selectedIdx === idx) {
            // Deselect if clicking same number
            selectedIdx = null
            selectedOp = null
            renderNumbers()
            return
          }

          if (selectedOp) {
            // Step 3: Select second number -> EXECUTE
            executeMerge(selectedIdx, idx, selectedOp)
          } else {
            // Switch selection to this number
            selectedIdx = idx
            renderNumbers()
          }
        }

        function handleOpClick(op) {
          if (selectedIdx === null) {
            // Must select number first
            qs('#resultRow').textContent = 'Please select a number first.'
            return
          }
          selectedOp = op
          renderNumbers()
        }

        function executeMerge(idxA, idxB, op) {
          const a = nums[idxA]
          const b = nums[idxB]
          let res = 0
          
          if (op === '+') res = a + b
          else if (op === '-') res = a - b
          else if (op === '×') res = a * b
          else if (op === '÷') {
             if (Math.abs(b) < EPS) {
               qs('#resultRow').textContent = 'Cannot divide by zero.'
               return
             }
             res = a / b
          }

          // Save history
          history.push({
            nums: nums.slice(),
            display: qs('#exprInput').value
          })

          // Update numbers
          // Replace A with result, Remove B
          // To keep array indices stable for replacement, we need to be careful
          // We will construct new array
          const newNums = []
          for(let i=0; i<nums.length; i++) {
            if (i === idxA) newNums.push(res)
            else if (i === idxB) continue
            else newNums.push(nums[i])
          }
          nums = newNums
          
          // Reset selection
          selectedIdx = null
          selectedOp = null
          
          // Update Display
          const opStr = `${Number.isInteger(a)?a:a.toFixed(2)} ${op} ${Number.isInteger(b)?b:b.toFixed(2)} = ${Number.isInteger(res)?res:res.toFixed(2)}`
          qs('#exprInput').value = opStr

          renderNumbers()

          // Check Win/Loss
          if (nums.length === 1) {
            const final = nums[0]
            if (Math.abs(final - 24) < EPS) {
              qs('#resultRow').textContent = 'Great job! Congratulations!'
              qs('#resultRow').style.color = '#28a745'
            } else {
              qs('#resultRow').textContent = 'Keep trying! Think again.'
              qs('#resultRow').style.color = '#dc3545'
            }
          }
        }

        function undo() {
          if (history.length > 0) {
            const state = history.pop()
            nums = state.nums
            qs('#exprInput').value = state.display
            selectedIdx = null
            selectedOp = null
            qs('#resultRow').textContent = ''
            renderNumbers()
          } else {
            // Initial state check
             // qs('#resultRow').textContent = 'Nothing to undo.'
          }
        }

        function newSet() {
          nums = genSolvable()
          lastNums = nums.slice() // Keep for replay
          history = []
          selectedIdx = null
          selectedOp = null
          qs('#exprInput').value = ''
          qs('#resultRow').textContent = ''
          qs('#resultRow').style.color = '#333'
          renderNumbers()
        }

        function replay() {
          nums = lastNums.slice()
          history = []
          selectedIdx = null
          selectedOp = null
          qs('#exprInput').value = ''
          qs('#resultRow').textContent = ''
          qs('#resultRow').style.color = '#333'
          renderNumbers()
        }

        function solve24(initialNums) {
          function dfs(list) {
            if (list.length === 1) {
              if (Math.abs(list[0].val - 24) < EPS) return list[0].expr
              return null
            }
            
            for (let i = 0; i < list.length; i++) {
              for (let j = 0; j < list.length; j++) {
                if (i === j) continue
                
                const a = list[i], b = list[j]
                const nextList = list.filter((_, idx) => idx !== i && idx !== j)
                
                // Operations
                // a + b
                let res = dfs([...nextList, {val: a.val + b.val, expr: `(${a.expr}+${b.expr})`}])
                if (res) return res
                
                // a * b
                res = dfs([...nextList, {val: a.val * b.val, expr: `(${a.expr}×${b.expr})`}])
                if (res) return res
                
                // a - b
                res = dfs([...nextList, {val: a.val - b.val, expr: `(${a.expr}-${b.expr})`}])
                if (res) return res
                
                // b - a
                res = dfs([...nextList, {val: b.val - a.val, expr: `(${b.expr}-${a.expr})`}])
                if (res) return res
                
                // a / b
                if (Math.abs(b.val) > EPS) {
                   res = dfs([...nextList, {val: a.val / b.val, expr: `(${a.expr}÷${b.expr})`}])
                   if (res) return res
                }
                
                // b / a
                if (Math.abs(a.val) > EPS) {
                   res = dfs([...nextList, {val: b.val / a.val, expr: `(${b.expr}÷${a.expr})`}])
                   if (res) return res
                }
              }
            }
            return null
          }
          
          const initialList = initialNums.map(n => ({val: n, expr: n.toString()}))
          let ans = dfs(initialList)
          // Remove outer parentheses if present
          if (ans && ans.startsWith('(') && ans.endsWith(')')) {
             return ans.slice(1, -1)
          }
          return ans
        }

        function showAnswer() {
           const solution = solve24(lastNums)
           if (solution) {
             qs('#resultRow').textContent = solution + ' = 24'
             qs('#resultRow').style.color = '#007aff'
           } else {
             qs('#resultRow').textContent = 'No solution found.'
             qs('#resultRow').style.color = '#dc3545'
           }
        }

        // Clean up unused functions
        function normalizeOps(s) { return s } 
        function validExpr(s) { return {ok:true} }
        function checkExpr() {}



        function nextRound() { newSet() }
        function tryAgain() { qs('#exprInput').value=''; qs('#resultRow').textContent='' }
        function resetNumbers() { nums = lastNums.slice(); renderNumbers(); tryAgain() }
        function showStats() {
          const st = readStats()
          let modal = qs('#tfStatsModal')
          if (!modal) {
            modal = document.createElement('div')
            modal.id = 'tfStatsModal'
            modal.style.position = 'fixed'
            modal.style.inset = '0'
            modal.style.background = 'rgba(0,0,0,0.35)'
            modal.style.display = 'flex'
            modal.style.alignItems = 'center'
            modal.style.justifyContent = 'center'
            const card = document.createElement('div')
            card.style.background = '#fff'
            card.style.border = '1px solid var(--color-border)'
            card.style.borderRadius = '12px'
            card.style.boxShadow = '0 1px 4px rgba(0,0,0,0.06)'
            card.style.padding = '20px'
            card.style.width = '360px'
            card.style.animation = 'modalIn .25s ease'
            const h = document.createElement('div')
            h.textContent = '24 Game Stats'
            h.style.fontWeight = '600'
            h.style.marginBottom = '10px'
            const info = document.createElement('div')
            info.className = 'secondary'
            info.style.marginBottom = '12px'
            const fastest = st.fastest!=null ? formatMs(st.fastest) : '—'
            info.textContent = `Rounds: ${st.rounds} · Wins: ${st.wins} · Fastest: ${fastest} · Best Streak: ${st.best_streak||0}`
            const row = document.createElement('div')
            row.style.display='flex'; row.style.justifyContent='flex-end'; row.style.gap='8px'
            const close = document.createElement('button')
            close.className='btn'; close.textContent='Close'
            close.addEventListener('click', ()=>{ modal.remove() })
            row.appendChild(close)
            card.appendChild(h); card.appendChild(info); card.appendChild(row)
            modal.appendChild(card)
            document.body.appendChild(modal)
            modal.addEventListener('click', (e)=>{ if (e.target===modal) modal.remove() })
          }
        }

        document.addEventListener('DOMContentLoaded', function(){
          const n1 = qs('#newSetBtn'); if (n1) n1.addEventListener('click', newSet)
          // const c = qs('#checkBtn'); if (c) c.addEventListener('click', checkExpr)
          
          const ub = qs('#undoBtn'); if (ub) ub.addEventListener('click', undo)
          const rb = qs('#replayBtn'); if (rb) rb.addEventListener('click', replay)
          const sab = qs('#showAnswerBtn'); if (sab) sab.addEventListener('click', showAnswer)
          
          qsa('.op-btn').forEach(btn => {
            btn.addEventListener('click', () => handleOpClick(btn.textContent))
          })

          newSet()
        })
      })()
    </script>
  </body>
</html>
